# Activa el script de parsing cuando hay cambios en la carpeta de XML
# Crea un Pull Request a la rama main con los cambios. Esto activa ci-tests.yml

name: ODI XML Automatic Parsing

on:
  push:
    branches: [ desarrollo ]
    paths:
      # GitHub Actions usa forward slashes (/) incluso para carpetas con nombres complejos
      - 'parsing/Proyecto-Apache-Airflow-main/etls/XMLs/*.xml'
      - 'parsing/Proyecto-Apache-Airflow-main/etls_extraccion/XMLs/*.xml'
      # Agregamos patrones recursivos por si la estructura var√≠a levemente
      - '**/etls/XMLs/**'
      - '**/etls_extraccion/XMLs/**'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  parse-and-open-pr:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[no-parsing]')"
    
    steps:
    # Paso 1: Descargar el c√≥digo del repositorio
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Paso 2: Configurar el entorno de Python
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip' # Cache para acelerar instalaciones futuras
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai
          # pip install -r requirements.txt

      # Paso 3: Correr el script (con failover en caso de errores de API)
      - name: Run Parser with Environment Failover
        run: |
          # Funci√≥n de reintento con diferentes entornos (ver readme de parsing): intenta desarrollo, si falla (exit code != 0), intenta produccion
          # Actualmente solo llama al de desarrollo, porque este no falla.
          
          # Guardamos la ruta absoluta de la ra√≠z del repo
          REPO_ROOT=$(pwd)

          run_with_retry() {
            local script_dir=$1
            local script_name=$2
            
            echo "------------------------------------------------------"
            echo "Cambiando a directorio: $script_dir"
            
            # Entramos a la carpeta donde vive el script para que sus rutas relativas funcionen
            cd "$REPO_ROOT/$script_dir"
            
            echo "üöÄ Paso 1: Intentando en AMBIENTE=desarrollo"
            if AMBIENTE=desarrollo python3 "$script_name"; then
              echo "‚úÖ √âxito en entorno de Desarrollo."
            else
              echo "‚ö†Ô∏è Fallo en Desarrollo. Reintentando..."
              echo "üöÄ Paso 2: Intentando en AMBIENTE=produccion"
              if AMBIENTE=produccion python3 "$script_name"; then
                echo "‚úÖ √âxito en entorno de Producci√≥n."
              else
                echo "‚ùå ERROR: Ambos ambientes fallaron para $script_name"
                exit 1
              fi
            fi
            
            # Volvemos a la ra√≠z para el siguiente proceso
            cd "$REPO_ROOT"
          }

          # Ejecuci√≥n para ETLs est√°ndar
          # Pasamos la CARPETA y luego el NOMBRE del script
          if [ -f "parsing/Proyecto-Apache-Airflow-main/etls/procesar_parseo.py" ]; then
            run_with_retry "parsing/Proyecto-Apache-Airflow-main/etls" "procesar_parseo.py"
          fi
          
          # Ejecuci√≥n para ETLs de extracci√≥n
          if [ -f "parsing/Proyecto-Apache-Airflow-main/etls_extraccion/procesar_parseo_extraccion.py" ]; then
            run_with_retry "parsing/Proyecto-Apache-Airflow-main/etls_extraccion" "procesar_parseo_extraccion.py"
          fi

      # Paso 4: Crear el Pull Request
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Actualizaci√≥n de XML"
          branch: "actualizaci√≥n-xml"
    
      - name: Commit and Push to Desarrollo
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add dags/migrados/
          if ! git diff --staged --quiet; then
            git commit -m "chore: auto-generated dags from xml [no-parsing]"
            git push origin desarrollo
          fi

      - name: Ensure Pull Request exists
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_EXISTS=$(gh pr list --head desarrollo --base main --json number --jq '.[0].number')
          if [ -z "$PR_EXISTS" ]; then
            gh pr create \
              --base main \
              --head desarrollo \
              --title "üöÄ Revisi√≥n de DAGs Migrados" \
              --body "Este PR contiene los DAGs generados autom√°ticamente. Revisar logs de QA para ajustes manuales."
          fi